#!/bin/bash

# Single space, newline at the end of file, and remove trailing whitespace from source files.
t=__wt.$$
trap 'rm -f $t' 0 1 2 3 13 15
cd -- "$(dirname -- "${BASH_SOURCE[0]}")"/.. || exit $?
[[ `uname -s` == Darwin ]] && EGREP="dist/pygrep.py -E" FGREP="dist/pygrep.py -F" || EGREP=egrep FGREP=fgrep

# Clear lines that only contain whitespace, compress multiple empty lines
# into a single line, discard trailing empty lines.
# Add a newline to the end of the file if there is not one.
whitespace()
{
    ! head $1 | grep -q 'automatically generated by SWIG' || return
    if [[ "$1" == *.py ]]; then
        # Special handling for Python, which allows multiple empty lines.
        cat $1 | sed -e 's/[[:space:]]*$//' > $t
        test "$(tail -c 1 "$1" | wc -l)" -eq 0 && echo >> $t
    else
        # All other file types.
        (cat $1 && echo) | sed -e 's/[[:space:]]*$//' | \
            cat -s | \
            sed -e '${' -e '/^$/d' -e '}' > $t
    fi
    cmp $t $1 > /dev/null 2>&1 || (echo "$1" && cp $t $1)
}

SUBDIRS="bench examples ext src test"
{
    if [[ "$1" = "-F" ]]; then
        last_commit_from_dev=$(python3 dist/common_functions.py last_commit_from_dev)
        git diff --name-only "${last_commit_from_dev}" $SUBDIRS | \
            $EGREP \
                -e '\.[ch]$' \
                -e '\.cpp$' \
                -e '\.dox$' \
                -e '\.in$' \
                -e '\.py$' \
                -e '\.sh$' \
                -e '\.yaml$' \
                -e '\.yml$' \
                -e '(^|/)s_' \
                -e '(^|/)CONFIG\.' \
                -e '(^|/)Makefile.am$' | \
            $FGREP -v \
                -e 'Makefile.in' \
                -e 'checksum/power8' \
                -e '3rdparty' \
                -e 'docs/tools' \
                -e 'log/log_auto' \
                ;

    else
        find $SUBDIRS \
            -name '*.[ch]' -o \
            -name '*.cpp' -o \
            -name '*.dox' -o \
            -name '*.in' -o \
            -name '*.py' -o \
            -name '*.sh' -o \
            -name '*.yaml' -o \
            -name '*.yml' -o \
            -name 's_*' -o \
            -name 'CONFIG.*' -o \
            -name 'Makefile.am' | \
            $FGREP -v \
                -e 'Makefile.in' \
                -e 'checksum/power8' \
                -e '3rdparty' \
                -e 'docs/tools' \
                -e 'log/log_auto' \
                ;
    fi
} | while read f ; do
    whitespace $f
done

exit 0
