#! /bin/sh

download_clang_format() {
	echo "$0: downloading clang-format for $(uname)"
	if [ `uname` = "Linux" ]; then
		wget https://s3.amazonaws.com/boxes.10gen.com/build/clang-format-3.8-rhel55.tar.gz -O dist/clang-format.tar.gz
	elif [ `uname` = "Darwin" ]; then
		wget https://s3.amazonaws.com/boxes.10gen.com/build/clang%2Bllvm-3.8.0-x86_64-apple-darwin.tar.xz -O dist/clang-format.tar.gz
	else
		echo "$0: unsupported environment"
		exit 1
	fi
	tar --strip=2 -C dist/ -xf dist/clang-format.tar.gz build/bin/clang-format && rm dist/clang-format.tar.gz
}

# Find the top-level WiredTiger directory and move to there.
cd `git rev-parse --show-toplevel` || exit 1

# Override existing Clang Format versions in the PATH.
export PATH="${PWD}/dist":$PATH

# Ensure that we have the correct version of clang-format.
clang_format_version="3.8.0"
clang-format --version | grep "version $clang_format_version" >/dev/null 2>&1
if test $? -ne 0; then
	echo "$0: incorrect/missing version of clang-format ($clang_format_version required)"
	download_clang_format
fi

case $# in
0)
	# Get all source files that aren't in s_clang-format.list.
	search=`find src -name '*.[chi]'`
	for f in `cat dist/s_clang-format.list`; do
		search=`echo "$search" | sed "\#$f#d"`
	done;;
1)
	search="$1";;
*)
	echo "usage: $0 [file]"
	exit 1;;
esac

# Format each file inplace.
clang-format -i --fallback-style=none $search
