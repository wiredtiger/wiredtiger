#! /bin/sh

# Installation of the clang development package isn't standard, list a
# couple of the places we're using.
export PATH=$PATH:/usr/local/clang50/bin:/usr/local/llvm-devel/bin

# Find the top-level WiredTiger directory and move to there.
p="$PWD"
while test "$p" != "/" ; do
	if test -d "$p/build_posix"; then
		break;
	fi
	p=`dirname $p`
done
test "$p" != "/" || {
	echo "$0: cannot find the WiredTiger top-level directory"
	exit 1
}

# Ensure that we have the correct version of clang-format.
clang_format_version="6.0.0"
clang-format --version | grep "version $clang_format_version" >/dev/null 2>&1
if test $? -ne 0; then
    echo "$0: found incorrect version of clang-format ($clang_format_version required)"
    exit 1
fi

cd $p || exit 1
echo "$0: running clang-format in $p..."

# Get all source files that aren't in s_clang-format.list.
search=`find src/ -name '*.[chi]'`
for f in `cat dist/s_clang-format.list`; do
	search=`echo "$search" | sed "\#$f#d"`
done

# Format each file inplace.
clang-format -i $search
