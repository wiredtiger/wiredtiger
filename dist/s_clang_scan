#!/bin/bash

t_out=__wt.$$.out
t_out_filtered=__wt.$$.out_filtered
t_build=__s_clang_scan_tmp_build
trap 'rm -rf $a $b $t_out $t_build' 0 1 2 3 13 15

# Find the top-level WiredTiger directory and move to there.
top=`git rev-parse --show-toplevel` && cd $top || exit 1
echo "$0: running scan-build in $PWD"

# Clang isn't installed in any standard place, find a binary we can use.
# If the caller gives us $SCANBUILD, check for $SCANCOMPILER and default
# to "clang".
scan="$SCANBUILD"
test -z "$scan" || compiler="${SCANCOMPILER:-clang}"

# Toolchain binaries.
toolchain_bin="/opt/mongodbtoolchain/v4/bin"
if test -z "$scan" &&
    test -x $toolchain_bin/clang &&
    test -x $toolchain_bin/scan-build; then
    compiler="$toolchain_bin/clang"
    scan="$toolchain_bin/scan-build"
fi

if test -z "$scan"; then
    echo "$0: no clang compiler and scan-build programs found"
    echo "$0: set \$SCANCOMPILER=/path/clang and \$SCANBUILD=/path/scan-build to continue"
    exit 1
fi
echo "$0: compiler: $compiler"
echo "$0: scan-build: $scan"

# Remove old reports.
rm -rf clangScanBuildReports && mkdir clangScanBuildReports
rm -rf ${t_build} && mkdir ${t_build}

cd ${t_build}
args="-o clangScanBuildReports"
args="$args --use-cc=$compiler"
$scan $args cmake CMAKE_C_FLAGS=-g \
    -DENABLE_STATIC=1 -DENABLE_SHARED=0 -DHAVE_DIAGNOSTIC=1 -DENABLE_STRICT=1 -G Ninja ../.> /dev/null
$scan $args ninja wt > ../$t_out 2>&1
cd ..

# Compare the set of errors/warnings and exit success when they're expected.
# clang_scan outputs errors/warnings with a leading file path followed by a
# colon, followed by the string "error:" or "warning:".
cat $t_out |
    egrep '^[a-z\./].*error: |^[a-z\./].*warning: ' | sed -e 's/:.*:.*://' | sort > $t_out_filtered
diff dist/s_clang_scan.diff $t_out_filtered > /dev/null && exit 0

echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-="
echo 'scan-build output differs from expected:'
echo '<<<<<<<<<< Expected >>>>>>>>>> Current'
echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-="
diff dist/s_clang_scan.diff $t_out_filtered
exit 1
