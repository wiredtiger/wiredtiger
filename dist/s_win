#!/bin/sh

t=__wt.$$
trap 'rm -f $t' 0 1 2 3 13 15

# Insulate against locale-specific sort order
LC_ALL=C
export LC_ALL

win_config()
{
	f='../build_win/wiredtiger_config.h'
	egrep '#define|#undef' \
	    ../build_posix/config.hin $f |
	    sed 's/^.*#//' |
	    awk '{print $2}' |
	    egrep -v '^(LT_OBJDIR|PACKAGE|VERSION)' |
	    sort | uniq -u > $t

	test -s $t && {
		echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-="
		echo "$f: configuration #defines do not match POSIX"
		echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-="
		cat $t
		exit 1
	}
}

win_export()
{
	# Build the Windows list of exported symbols.
	f='../build_win/wiredtiger.def'
	(echo 'LIBRARY WIREDTIGER'
	 echo 'EXPORTS'
	 sed -e '/^$/d' \
	     -e '/^#/d' \
	     -e 's/^/    /') < s_export.list > $t
	 cmp $t $f > /dev/null 2>&1 ||
	     (echo "Building $f" && rm -f $f && cp $t $f)
}

win_pack()
{
	# If we don't have matching pack-begin and pack-end calls, we don't get
	# an error, we just get a Windows performance regression.
	cnt=`egrep WT_PACKED_STRUCT ../src/include/*.h ../src/include/*.in |
	    awk '{ ++line } END { print line }'`
	if test `expr "$cnt" % 2` -ne 0; then
		echo 'Error: mismatched WT_PACKED_STRUCT_BEGIN/END lines.'
		exit 1
	fi
}

win_config
win_export
win_pack

exit 0
