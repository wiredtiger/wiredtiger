#!/bin/bash

# Complain about unused functions

cd -- "$(dirname -- "${BASH_SOURCE[0]}")" || exit $?

# List of files to search.
l=`sed -e '/^[a-z]/!d' -e 's/[	 ].*$//' -e 's,^,../,' filelist`
l="$l `echo ../src/*/*_inline.h ../src/utilities/*.c ../bench/wtperf/*.c ../bench/tiered/*.c`"

{
    # Copy out the functions we don't use, but it's OK.
    sed -e '/^$/d' -e '/^#/d' < s_funcs.list

    # Get the list of functions
    search=`cat $l | ./pygrep.py '^[a-zA-Z0-9_][a-zA-Z0-9_]*\(' | sed -e 's/(.*//' | sort -u`

    # Print the list of functions, followed by the occurrences: we're looking for
    # functions that only appear once
    echo "$search"
    sed -n '/{/,/^}/p' $l | ./pygrep.py -fwo $search

    sed -n '/^#define/,/[^\\]$/p' ../src/include/*.h ../src/include/*.in | ./pygrep.py -fwho $search
} | ./pygrep.py -v '^__ut_' | sort | uniq -u

exit 0
