#! /bin/bash

# Find FIXME comments related to the ticket potentially indicated by the branch name.
# The script only fails if the branch name follows a specific syntax and FIXME comments are found,
# otherwise, the script exits without failing.

# Retrieve the current branch name.
branch_name=$(git rev-parse --abbrev-ref HEAD)

# We expect the following syntax (case insensitive): wt-<digits>[-<alphanum>].
regex="^(wt|WT|wT|Wt)-[0-9]+(-[a-zA-Z0-9-]+)?"
if [[ ! $branch_name =~ $regex ]]; then
    exit 0
fi

# Get what could be the ticket id.
ticket_id=$(echo "$branch_name" | cut -d "-" -f-2)

# Check if the suspected id only contain numbers.
regex="^(wt|WT|wT|Wt)-[0-9]+$"
if [[ ! $ticket_id =~ $regex ]]; then
    exit 0
fi

# Check for fixme comments related to the ticket left behind.
if grep -inr --exclude-dir=.git "fix.*$ticket_id" ../. > /dev/null 2>&1; then
    echo "Please fix the FIXME comments related to $ticket_id."
    exit 1
fi

exit 0
