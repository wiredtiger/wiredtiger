#! /bin/bash

# Find "fix" and "todo" comments related to the ticket potentially indicated by the branch name.
# The script only fails if the branch name follows a specific syntax and those comments are found.

# Retrieve the current branch name.
branch_name=$(git rev-parse --abbrev-ref HEAD)

# We expect the following syntax (case insensitive): wt-<digits>[-<alphanum>].
regex="^(wt|WT|wT|Wt)-[0-9]+(-[a-zA-Z0-9-]+)?"
if [[ ! $branch_name =~ $regex ]]; then
    exit 0
fi

# Get what could be the ticket id.
ticket_id=$(echo "$branch_name" | cut -d "-" -f-2)

# Check for comments related to the ticket.
if grep -inr --exclude-dir=.git "fix.*$ticket_id" ../. > /dev/null 2>&1; then
    echo "Please fix the comments related to $ticket_id."
    exit 1
fi
if grep -inr --exclude-dir=.git "todo.*$ticket_id" ../. > /dev/null 2>&1; then
    echo "Please fix the todo comments related to $ticket_id."
    exit 1
fi

exit 0
