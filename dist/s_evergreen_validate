#!/bin/sh

t=__wt.$$
trap 'rm -f $t' 0 1 2 3 13 15

fast=1
case "$1" in
    -F) # Run fast.
        fast=0
        shift;;
    *)
        if test $# -gt 1 ; then
            echo "Usage: $0 [-F]"
            echo "-F only run validation commands if evergreen yml files have been modified"
        fi
        break;;
esac

if [ $(command -v evergreen) ] && [ -f ~/.evergreen.yml ]; then
    if test $fast -eq 0 ; then
        # Check the evergreen.yml files for modifications.
        search=`git diff --name-only $(git merge-base --fork-point develop) | grep -E 'evergreen.*\.yml$'`
        # If we didn't find any files then exit.
        if test -z $search; then
            exit 0
        fi
    fi
    cd ..
    evergreen validate -p wiredtiger test/evergreen.yml > dist/$t 2>&1
    exit1=$?
    evergreen validate -p wiredtiger test/evergreen_develop.yml >> dist/$t 2>&1
    exit2=$?
    cd dist
fi

if test $exit1 -eq 1 -o $exit2 -eq 1 ; then
    echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-="
    echo "$0 failed with output:"
    cat $t
    echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-="
fi
exit 0
